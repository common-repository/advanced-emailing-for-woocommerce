rndefine("#RNEmailFormulaCore",["#RNEmailCore/Sanitizer"],(function(t){"use strict";class e{constructor(t,e){this.Options=t,this.Parent=e}get Retriever(){return this.Parent.Retriever}get Type(){return this.Options.T}}class s{static GetFRElement(t,e){if(null==s.FieldDictionary[t.T])throw new Error("Formula element was not found "+t.T);return new s.FieldDictionary[t.T](t,e)}static AddField(t,e){s.FieldDictionary[t]=e}}s.FieldDictionary={};class r{constructor(){this.IsFRDataSource=!0}}class i extends e{constructor(t,e){super(t,e)}Parse(){let t=Number(this.Options.d);if(isNaN(t))throw new Error("Invalid number "+t);return t}}s.AddField("NUM",i);class n{static SanitizeNumber(t,e=0){return null==t?e:t instanceof r?t.GetNumber():isNaN(t)?e:Number(t)}static NotifyReturnToParent(t){for(;["BLO","MA","FOR","FE"].indexOf(t.Parent.Options.T)<0;)t=t.Parent;t.Parent.ReturnWasExecuted()}static NotifyBreakToParent(t){for(;["FOR","FE"].indexOf(t.Parent.Options.T)<0;)t=t.Parent;t.Parent.BreakWasExecuted()}}class a extends e{constructor(t,e){super(t,e),this.Statement=s.GetFRElement(t.d,this)}Parse(){return n.NotifyReturnToParent(this),this.Statement.Parse()}}s.AddField("RE",a);class o extends e{constructor(t,e){super(t,e),this.Left=s.GetFRElement(t.L,this),this.Right=s.GetFRElement(t.R,this),this.Subtype=t.St}Parse(){let t=this.Left.Parse(),e=this.Right.Parse();switch(this.Subtype){case"Add":return t=t instanceof r?"string"==typeof e?t.GetText():t.GetNumber():isNaN(Number(t))?t.toString():Number(t),e=e instanceof r?"string"==typeof t?e.GetText():e.GetNumber():isNaN(Number(t))?e.toString():Number(e),t+e;case"Sub":return this.ToNumber(t)-this.ToNumber(e);case"Mult":return this.ToNumber(t)*this.ToNumber(e);case"Div":return e=this.ToNumber(e),0==e?0:this.ToNumber(t)/e;case"Eq":return this.ToScalar(t)==this.ToScalar(e);case"NEq":return this.ToScalar(t)!=this.ToScalar(e);case"Gt":return this.ToScalar(t)>this.ToScalar(e);case"Gte":return this.ToScalar(t)>=this.ToScalar(e);case"Lt":return this.ToScalar(t)<this.ToScalar(e);case"Lte":return this.ToScalar(t)<=this.ToScalar(e)}}ToScalar(t){return Array.isArray(t)?t.reduce(((t,e)=>t+this.ToScalar(e)),0):t instanceof r?t.GetText():t}ToNumber(t){return Array.isArray(t)?t.reduce(((t,e)=>t+this.ToNumber(e)),0):t instanceof r?t.GetNumber():(t=Number(t),isNaN(t)?0:t)}}s.AddField("BE",o);class l extends e{constructor(t,e){super(t,e),this.Id=this.Options.Id}Parse(){return this.Retriever.GetFieldById(this.Id)}}s.AddField("RNF",l);class h extends e{constructor(t,e){super(t,e),this.Sentence=s.GetFRElement(this.Options.d,this)}Parse(){return this.Sentence.Parse()}}s.AddField("PE",h);class u extends e{constructor(t,e){super(t,e)}Parse(){return null}}s.AddField("Null",u);class c extends e{constructor(t,e){super(t,e)}Parse(){return this.Options.d.toString()}}s.AddField("STR",c);class d extends e{constructor(t,e){super(t,e),this.Items=[],t.d.forEach((t=>{this.Items.push(s.GetFRElement(t,this))}))}Parse(){let t=[];return this.Items.forEach((e=>t.push(e.Parse()))),t}}s.AddField("ARR",d);class p extends e{constructor(t,e){super(t,e),this.Cond=s.GetFRElement(t.C,this),this.Tr=s.GetFRElement(t.Tr,this),this.Fa=s.GetFRElement(t.Fa,this)}Parse(){return this.Cond.Parse()?this.Tr.Parse():this.Fa.Parse()}}s.AddField("CE",p);class F extends e{constructor(t,e){super(t,e)}Parse(){return this.Options.d}}s.AddField("BL",F);class R extends r{constructor(t){super(),this.Field=t}GetNumber(){return this.Field.GetPrice()}GetText(){return this.Field.GetText()}GetPrice(){return this.Field.GetPrice()}}class P extends e{constructor(t,e){super(t,e),this.Subt=this.Options.St,"Pr"==this.Options.St?this.Prop=this.Options.Pr:this.Prop=s.GetFRElement(this.Options.Pr,this),this.Caller=s.GetFRElement(this.Options.C,this),this.Args=[],Array.isArray(this.Options.Args)&&this.Options.Args.forEach((t=>this.Args.push(s.GetFRElement(t,this))))}Parse(){let t=this.Caller.Parse();switch(this.Subt){case"Pr":let e=String(this.Prop);return t instanceof R&&(t=t.Field),null==t[e]?null:e in t?"function"==typeof t[e]?t[e].apply(t,this.Args.map((t=>t.Parse()))):t[e]:null;case"Arr":let s=this.Prop.Parse();return null==s?null:Array.isArray(t)&&null!=t[s]?t[s]:null}}Assign(t){let e=this.Caller.Parse();switch(this.Subt){case"Arr":let s=this.Prop.Parse(),r=n.SanitizeNumber(s,null);if(null==r)return null;if(!Array.isArray(e)||e.length<r)return null;e[r]=t;break;case"Pr":if(this.Args.length>0)return;let i=String(this.Prop);return i in e?"function"!=typeof e[i]?e[i]=t:void 0:null}}}s.AddField("ME",P);class m{constructor(){this.VarDictionary=new Map,this.FunctionDictionary=m.GlobalFunctions}SetVar(t,e){this.VarDictionary.set(t,e)}GetVar(t){return this.VarDictionary.has(t)?this.VarDictionary.get(t):null}AddFunction(t,e){this.FunctionDictionary.set(t,e)}CallFunction(t,e){return this.FunctionDictionary.has(t)?(e=[this,...e],this.FunctionDictionary.get(t).apply(null,e)):null}}m.GlobalFunctions=new Map;class S extends e{constructor(t,e){super(t,e),this.Asignee=s.GetFRElement(this.Options.As,this),this.Value=s.GetFRElement(this.Options.D,this)}Parse(){let t=this.Value.Parse();this.Asignee.Type,this.Asignee.Assign(t)}}s.AddField("AE",S);class A extends e{constructor(t,e){super(t,e),this.Name=this.Options.d}Parse(){return this.Retriever.GetVar(this.Name)}Assign(t){this.Retriever.SetVar(this.Name,t)}}s.AddField("VAR",A);class x extends e{constructor(t,e){super(t,e),this.Subtype=t.St,this.Expression=s.GetFRElement(this.Options.d,this)}Parse(){return!this.Expression.Parse()}}s.AddField("UE",x);class E extends e{constructor(t,e){super(t,e),this.FunctionName=this.Options.Fn,this.Args=[],this.Options.Ar.forEach((t=>this.Args.push(s.GetFRElement(t,this))))}Parse(){return this.Retriever.CallFunction(this.FunctionName,this.Args.map((t=>t.Parse())))}}s.AddField("FC",E);class y extends e{constructor(t,e){super(t,e),this.Condition=s.GetFRElement(this.Options.Con,this),this.TrueAction=s.GetFRElement(this.Options.Tr,this),null!=this.Options.Fa&&(this.FalseAction=s.GetFRElement(this.Options.Fa,this))}Parse(){return this.Condition.Parse()?this.TrueAction.Parse():null!=this.FalseAction?this.FalseAction.Parse():void 0}}s.AddField("IF",y);class f extends e{constructor(t,e){super(t,e),this.ShouldReturn=!1,this.Sentences=[],this.Options.d.forEach((t=>this.Sentences.push(s.GetFRElement(t,this))))}Parse(){let t=null;for(let e of this.Sentences)if(t=e.Parse(),this.ShouldReturn)break;return t}ReturnWasExecuted(){this.ShouldReturn=!0,n.NotifyReturnToParent(this)}}s.AddField("BLO",f);class N extends e{constructor(t,e){super(t,e),this.ShouldBreak=!1,this.Var=s.GetFRElement(t.V,this),null!=t.C&&(this.Cond=s.GetFRElement(t.C,this)),null!=t.I&&(this.Inc=s.GetFRElement(t.I,this)),this.Statement=s.GetFRElement(t.S,this)}Parse(){this.ShouldBreak=!1,this.Var.Parse();let t=null;for(;null==this.Cond||1==this.Cond.Parse();){var e;if(t=this.Statement.Parse(),this.ShouldBreak)return t;null===(e=this.Inc)||void 0===e||e.Parse()}return t}ReturnWasExecuted(){this.ShouldBreak=!0,n.NotifyReturnToParent(this)}BreakWasExecuted(){this.ShouldBreak=!0}}s.AddField("FOR",N);class T extends e{constructor(t,e){super(t,e)}Parse(){n.NotifyBreakToParent(this)}}s.AddField("BR",T);class G extends e{constructor(t,e){super(t,e),this.Value="",this.Key="",this.ShouldBreak=!1,this.Expression=s.GetFRElement(t.E,this),this.Value=t.V,this.Key=t.K,this.Statement=s.GetFRElement(t.D,this)}Parse(){let t=this.Expression.Parse(),e=[];if(Array.isArray(t))e=Array.from(t.keys());else for(let s in t)e.push(s);for(let s of e){let e=t[s];this.Retriever.SetVar(this.Value,e),""!=this.Key&&this.Retriever.SetVar(this.Key,s);let r=this.Statement.Parse();if(this.ShouldBreak)return r}}ReturnWasExecuted(){this.ShouldBreak=!0,n.NotifyReturnToParent(this)}BreakWasExecuted(){this.ShouldBreak=!0}}s.AddField("FE",G),exports.FRMain=class extends e{constructor(t,e){super(t,null),this.ShouldReturn=!1,this.Sentences=[],this._retriever=e,Array.isArray(null==t?void 0:t.d)&&t.d.forEach((t=>{this.Sentences.push(s.GetFRElement(t,this))}))}get Retriever(){return this._retriever}InternalParse(){let t=null;for(let e of this.Sentences)if(t=e.Parse(),this.ShouldReturn)break;return t}ParsePrice(){return t.Sanitizer.SanitizeNumber(this.Parse())}Parse(){let e=this.InternalParse();return e instanceof r?(Array.isArray(e)&&e.reduce(((t,e)=>e.GetNumber()+t),0),e.GetText()):Array.isArray(e)?e.map((e=>t.Sanitizer.SanitizeString(e))).join(", "):null==e?null:["boolean","string","number"].indexOf(typeof e)>=0?e:e.toString()}GetType(){return"Main"}ReturnWasExecuted(){this.ShouldReturn=!0}ParseText(){let t=this.InternalParse();return t instanceof r?Array.isArray(t)?t.map((t=>t.GetText())).join(", "):t.GetText():Array.isArray(t)?t.join(", "):t}},exports.FRNumber=i,exports.Return=a,exports.FRBinaryExpression=o,exports.FRField=l,exports.ParenthezisedExpression=h,exports.FRNull=u,exports.FRString=c,exports.FRArray=d,exports.FRCondE=p,exports.FRBool=F,exports.FRCondE=p,exports.FRMembE=P,exports.FRDataRetriever=m,exports.FRFieldSource=r,exports.FRAssigmentExpression=S,exports.FRVariable=A,exports.UnaryExpression=x,exports.FRFCExpression=E,exports.FRIfStatement=y,exports.FRBlock=f,exports.FRFor=N,exports.FRBreak=T,exports.FRForE=G}));
